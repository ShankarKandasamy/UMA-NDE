<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>UMA Capture</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent: #00d4aa;
            --accent-dim: #00d4aa22;
            --text-primary: #f0f0f5;
            --text-secondary: #8888aa;
            --border: #2a2a3a;
            --success: #00d4aa;
            --error: #ff4466;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header */
        header {
            padding: 1rem 1.25rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 1.5rem 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* Capture Zone */
        .capture-zone {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .capture-zone:active {
            transform: scale(0.98);
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .capture-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .capture-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: var(--accent-dim);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .capture-icon svg {
            width: 32px;
            height: 32px;
            stroke: var(--accent);
        }

        .capture-zone h2 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .capture-zone p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-primary);
            font-family: inherit;
        }

        .action-btn:active {
            transform: scale(0.95);
            border-color: var(--accent);
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent);
        }

        .action-btn span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Preview Section */
        .preview-section {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }

        .preview-section.active {
            display: flex;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--error);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .preview-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .file-icon {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .preview-item .file-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--text-secondary);
        }

        .preview-item .file-icon span {
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--error);
            border: none;
            color: white;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Notes Input */
        .notes-section {
            display: block;
        }

        .notes-container {
            position: relative;
        }

        .notes-input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            padding-right: 3.5rem;
            padding-bottom: 2.5rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            min-height: 100px;
        }

        .notes-input::placeholder {
            color: var(--text-secondary);
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Voice Button */
        .voice-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .voice-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
        }

        .voice-btn.listening {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
            animation: pulse-ring 1.5s infinite;
        }

        .voice-btn.processing {
            background: var(--warning);
            border-color: var(--warning);
            color: var(--bg-primary);
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(0, 212, 170, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 212, 170, 0);
            }
        }

        /* Voice Status */
        .voice-status {
            position: absolute;
            bottom: 8px;
            left: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .voice-status.active {
            opacity: 1;
        }

        .voice-status .waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 16px;
        }

        .voice-status .waveform span {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            animation: waveform 0.5s ease-in-out infinite;
        }

        .voice-status .waveform span:nth-child(1) {
            animation-delay: 0s;
        }

        .voice-status .waveform span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .voice-status .waveform span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .voice-status .waveform span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .voice-status .waveform span:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes waveform {

            0%,
            100% {
                height: 4px;
            }

            50% {
                height: 16px;
            }
        }

        /* STT Provider Badge */
        .stt-badge {
            position: absolute;
            bottom: 8px;
            right: 60px;
            font-size: 0.65rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0.7;
        }

        /* Upload Button */
        .upload-section {
            margin-top: auto;
            padding-top: 1rem;
            cursor: pointer;
        }

        .upload-btn {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .upload-btn:disabled {
            background: var(--border);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .upload-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        .upload-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Upload Progress */
        .upload-progress {
            display: none;
            flex-direction: column;
            gap: 0.5rem;
        }

        .upload-progress.active {
            display: flex;
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast.success svg {
            stroke: var(--success);
        }

        .toast.error svg {
            stroke: var(--error);
        }

        /* Hidden file inputs */
        input[type="file"] {
            display: none;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 200;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            padding: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .setting-item {
            margin-bottom: 1rem;
        }

        .setting-item label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .setting-item input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .setting-item input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .save-settings-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">UMA_CAPTURE</div>
        <div class="status-dot" id="statusDot" title="Connected"></div>
    </header>

    <main>
        <!-- Capture Zone -->
        <div class="capture-zone" id="captureZone">
            <div class="capture-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                    <circle cx="12" cy="13" r="4" />
                </svg>
            </div>
            <h2>Tap to Capture</h2>
            <p>Take a photo or select files</p>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-btn" id="cameraBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                    <circle cx="12" cy="13" r="4" />
                </svg>
                <span>Camera</span>
            </button>
            <button class="action-btn" id="galleryBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <polyline points="21 15 16 10 5 21" />
                </svg>
                <span>Gallery</span>
            </button>
            <button class="action-btn" id="filesBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                <span>Files</span>
            </button>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="previewSection">
            <div class="preview-header">
                <h3>Ready to Upload (<span id="fileCount">0</span>)</h3>
                <button class="clear-btn" id="clearBtn">Clear All</button>
            </div>
            <div class="preview-grid" id="previewGrid"></div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section" id="notesSection">
            <div class="notes-container">
                <textarea class="notes-input" id="notesInput"
                    placeholder="Describe what you're uploading...&#10;&#10;e.g., 'Calibration setup for XYZ company job #ABC123, butt weld UT inspection, 10mm carbon steel'"></textarea>
                <button class="voice-btn" id="voiceBtn" title="Voice input">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                        <line x1="12" y1="19" x2="12" y2="23" />
                        <line x1="8" y1="23" x2="16" y2="23" />
                    </svg>
                </button>
                <div class="voice-status" id="voiceStatus">
                    <div class="waveform">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <span id="voiceStatusText">Listening...</span>
                </div>
                <div class="stt-badge" id="sttBadge">Deepgram</div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Uploading...</div>
            </div>
            <button class="upload-btn" id="uploadBtn" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                Upload to UMA
            </button>
        </div>
    </main>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12" />
        </svg>
        <span id="toastText">Upload successful!</span>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close" id="closeSettings">&times;</button>
            </div>
            <div class="setting-item">
                <label>API Endpoint</label>
                <input type="url" id="apiEndpoint" placeholder="https://your-worker.workers.dev/upload">
            </div>
            <div class="setting-item">
                <label>API Key (Upload)</label>
                <input type="password" id="apiKey" placeholder="Your upload API key">
            </div>
            <button class="save-settings-btn" id="saveSettings">Save Settings</button>
        </div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
    <input type="file" id="galleryInput" accept="image/*" multiple>
    <input type="file" id="fileInput" accept=".pdf,.csv,.xlsx,.xls,.doc,.docx,.jpg,.jpeg,.png,.heic" multiple>

    <script>
        // State
        let pendingFiles = [];
        let settings = {
            apiEndpoint: localStorage.getItem('uma_endpoint') || '',
            apiKey: localStorage.getItem('uma_apikey') || ''
        };

        // DOM Elements
        const captureZone = document.getElementById('captureZone');
        const cameraBtn = document.getElementById('cameraBtn');
        const galleryBtn = document.getElementById('galleryBtn');
        const filesBtn = document.getElementById('filesBtn');
        const cameraInput = document.getElementById('cameraInput');
        const galleryInput = document.getElementById('galleryInput');
        const fileInput = document.getElementById('fileInput');
        const previewSection = document.getElementById('previewSection');
        const previewGrid = document.getElementById('previewGrid');
        const fileCount = document.getElementById('fileCount');
        const clearBtn = document.getElementById('clearBtn');
        const notesSection = document.getElementById('notesSection');
        const notesInput = document.getElementById('notesInput');
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const voiceStatusText = document.getElementById('voiceStatusText');
        const sttBadge = document.getElementById('sttBadge');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toastText');
        const statusDot = document.getElementById('statusDot');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const apiEndpointInput = document.getElementById('apiEndpoint');
        const apiKeyInput = document.getElementById('apiKey');

        // Initialize settings inputs
        apiEndpointInput.value = settings.apiEndpoint;
        apiKeyInput.value = settings.apiKey;

        // Event Listeners
        captureZone.addEventListener('click', () => cameraInput.click());
        cameraBtn.addEventListener('click', () => cameraInput.click());
        galleryBtn.addEventListener('click', () => galleryInput.click());
        filesBtn.addEventListener('click', () => fileInput.click());

        // Long press on logo to open settings
        let pressTimer;
        document.querySelector('.logo').addEventListener('touchstart', () => {
            pressTimer = setTimeout(() => settingsModal.classList.add('active'), 800);
        });
        document.querySelector('.logo').addEventListener('touchend', () => clearTimeout(pressTimer));
        document.querySelector('.logo').addEventListener('click', (e) => {
            if (e.detail === 3) settingsModal.classList.add('active'); // Triple click on desktop
        });

        closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) settingsModal.classList.remove('active');
        });

        saveSettingsBtn.addEventListener('click', () => {
            settings.apiEndpoint = apiEndpointInput.value.trim();
            settings.apiKey = apiKeyInput.value.trim();
            localStorage.setItem('uma_endpoint', settings.apiEndpoint);
            localStorage.setItem('uma_apikey', settings.apiKey);
            settingsModal.classList.remove('active');
            showToast('Settings saved', 'success');
            updateStatus();
        });

        // File handling
        [cameraInput, galleryInput, fileInput].forEach(input => {
            input.addEventListener('change', handleFileSelect);
        });

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (!pendingFiles.some(f => f.name === file.name && f.size === file.size)) {
                    pendingFiles.push(file);
                }
            });
            updatePreview();
            e.target.value = ''; // Reset input
        }

        function updatePreview() {
            previewGrid.innerHTML = '';
            pendingFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'preview-item';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.className = 'file-icon';
                    const ext = file.name.split('.').pop().toUpperCase();
                    icon.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span>${ext}</span>
                    `;
                    item.appendChild(icon);
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    pendingFiles.splice(index, 1);
                    updatePreview();
                });
                item.appendChild(removeBtn);

                previewGrid.appendChild(item);
            });

            const hasFiles = pendingFiles.length > 0;
            previewSection.classList.toggle('active', hasFiles);
            // Notes section is always visible for voice-first workflow
            uploadBtn.disabled = !hasFiles || !settings.apiEndpoint;
            fileCount.textContent = pendingFiles.length;
        }

        clearBtn.addEventListener('click', () => {
            pendingFiles = [];
            notesInput.value = '';
            updatePreview();
        });

        // Upload
        uploadBtn.addEventListener('click', uploadFiles);

        async function uploadFiles() {
            if (!settings.apiEndpoint) {
                showToast('Please configure API endpoint in settings', 'error');
                return;
            }

            uploadBtn.style.display = 'none';
            uploadProgress.classList.add('active');

            try {
                const formData = new FormData();
                pendingFiles.forEach((file, i) => {
                    formData.append(`file_${i}`, file);
                });
                formData.append('notes', notesInput.value);
                formData.append('timestamp', new Date().toISOString());
                formData.append('device', navigator.userAgent);

                const response = await fetch(settings.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': settings.apiKey
                    },
                    body: formData
                });

                // Simulate progress (real progress requires XHR)
                for (let i = 0; i <= 100; i += 10) {
                    progressFill.style.width = i + '%';
                    progressText.textContent = `Uploading... ${i}%`;
                    await new Promise(r => setTimeout(r, 50));
                }

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }

                const result = await response.json();
                showToast(`${pendingFiles.length} file(s) uploaded successfully`, 'success');

                // Clear state
                pendingFiles = [];
                notesInput.value = '';
                updatePreview();

            } catch (error) {
                console.error('Upload error:', error);
                showToast(error.message || 'Upload failed', 'error');
            } finally {
                uploadBtn.style.display = 'flex';
                uploadProgress.classList.remove('active');
                progressFill.style.width = '0%';
            }
        }

        function showToast(message, type = 'success') {
            toastText.textContent = message;
            toast.className = `toast ${type}`;
            toast.querySelector('svg').innerHTML = type === 'success'
                ? '<polyline points="20 6 9 17 4 12"/>'
                : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateStatus() {
            const connected = settings.apiEndpoint && settings.apiKey;
            statusDot.style.background = connected ? 'var(--success)' : 'var(--warning)';
            statusDot.style.boxShadow = connected ? '0 0 8px var(--success)' : '0 0 8px var(--warning)';
            statusDot.title = connected ? 'Connected' : 'Not configured';
        }

        // Drag and drop
        captureZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            captureZone.classList.add('drag-over');
        });

        captureZone.addEventListener('dragleave', () => {
            captureZone.classList.remove('drag-over');
        });

        captureZone.addEventListener('drop', (e) => {
            e.preventDefault();
            captureZone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (!pendingFiles.some(f => f.name === file.name && f.size === file.size)) {
                    pendingFiles.push(file);
                }
            });
            updatePreview();
        });

        // ============================================
        // SPEECH-TO-TEXT (Web Speech API with Streaming)
        // ============================================

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let finalTranscript = '';  // Committed text from previous results
        let interimTranscript = ''; // Current in-progress text

        function updateSttBadge() {
            if (SpeechRecognition) {
                sttBadge.textContent = 'Web Speech';
                sttBadge.style.color = 'var(--accent)';
            } else {
                sttBadge.textContent = 'Not Supported';
                sttBadge.style.color = 'var(--error)';
            }
        }

        function initSpeechRecognition() {
            if (!SpeechRecognition) {
                return null;
            }

            const rec = new SpeechRecognition();
            rec.continuous = true;           // Keep listening until stopped
            rec.interimResults = true;       // Enable streaming
            rec.lang = 'en-US';

            rec.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                voiceBtn.classList.remove('processing');
                voiceStatus.classList.add('active');
                voiceStatusText.textContent = 'Listening...';
                // Store existing text as the base
                finalTranscript = notesInput.value;
                if (finalTranscript && !finalTranscript.endsWith(' ') && !finalTranscript.endsWith('\n')) {
                    finalTranscript += ' ';  // Add space before new speech
                }
                interimTranscript = '';
            };

            rec.onresult = (event) => {
                interimTranscript = '';

                // Process results from the current result index
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;

                    if (result.isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Update textarea with final + interim (interim shown as-is for MVP)
                notesInput.value = finalTranscript + interimTranscript;

                // Auto-scroll textarea to bottom
                notesInput.scrollTop = notesInput.scrollHeight;
            };

            rec.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopListening();

                let errorMsg = 'Speech error';
                switch (event.error) {
                    case 'no-speech':
                        errorMsg = 'No speech detected. Try again.';
                        break;
                    case 'audio-capture':
                        errorMsg = 'No microphone found.';
                        break;
                    case 'not-allowed':
                        errorMsg = 'Microphone permission denied.';
                        break;
                    case 'network':
                        errorMsg = 'Network error. Check connection.';
                        break;
                }
                showToast(errorMsg, 'error');
            };

            rec.onend = () => {
                // Recognition ended (either manually or automatically)
                if (isListening) {
                    // If we're still supposed to be listening, restart
                    // This handles the case where recognition auto-stops
                    try {
                        rec.start();
                    } catch (e) {
                        stopListening();
                    }
                } else {
                    stopListening();
                }
            };

            return rec;
        }

        function startListening() {
            if (!SpeechRecognition) {
                showToast('Speech recognition not supported in this browser', 'error');
                return;
            }

            if (!recognition) {
                recognition = initSpeechRecognition();
            }

            if (!recognition) {
                showToast('Failed to initialize speech recognition', 'error');
                return;
            }

            try {
                recognition.start();
            } catch (e) {
                // Already started, stop and restart
                recognition.stop();
            }
        }

        function stopListening() {
            isListening = false;
            voiceBtn.classList.remove('listening', 'processing');
            voiceStatus.classList.remove('active');

            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Ignore errors when stopping
                }
            }

            // Commit any remaining interim transcript
            if (interimTranscript) {
                finalTranscript += interimTranscript;
                notesInput.value = finalTranscript;
                interimTranscript = '';
            }
        }

        // Voice button toggle
        voiceBtn.addEventListener('click', () => {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        });

        // ============================================
        // END SPEECH-TO-TEXT
        // ============================================

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }

        // Initial status check
        updateStatus();
        updateSttBadge();
    </script>
</body>

</html>